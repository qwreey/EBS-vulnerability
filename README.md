
# EBS 교사용 다운로드 취약점

이 메일로 확인 답장이 없으며, 해당 이슈에 대한 의견이 1달 안에 나오지 않는 경우. 이 취약점을 github 개인 저장소에 공개하겠습니다. 저는 사전적인 고지를 드렸으며 답장하기에 충분한 시간을 드렸으므로. 피해를 사전적으로 예방할 충분한 권리를 제공했다고 생각합니다. 따라서 이 글이 무시됨으로써 일어나는 모든 금전적인 피해에 대한 책임은 EBS 에 있습니다. 필요에 따라 더 많은 시간을 요구해야 하는 경우 이 메일로 답장 부탁드립니다.

이는 여러 사건과 제보를 방치하는것을 막고자 함에 있습니다. 제보자 `Qwreey` 는 아무런 법적인 책임이 없습니다.

## 시나리오

EBS 가 수능특강 다운로드 서비스를 종료한 후, 교사인증이 되어 있어야지만 수능특강 PDF 파일을 다운로드 할 수 있도록 사이트 로직을 변경하였습니다. 그러나 이 모든 작업들은 프론트엔드 에서만 이루워졌으며, 백엔드에서 아무런 검증이 없었기 때문에 유저는 교사 인증이 없더라도 PDF 파일을 다운로드 할 수 있는 방법이 있었습니다.

아래는 다음이 이루워질 수 있도록 만든 문제점입니다.

## 사이트의 문제점

### 난독화의 부재

EBSi 사이트의 프론트 엔드 javascript 코드에는 아무런 난독화가 없습니다. 따라서 유저는 사이트의 모든 로직들을 확인할 수 있으며, 이를 통해서 리버스 엔지니어링이 매우 간단하게 이루워 질 수 있습니다.

또한, 개발시 생성한 주석도 전혀 지워지지 않았기 때문에, 해당 함수와 필드가 무엇을 위해 있는것인지 바로바로 파악할 수 있었습니다

![](2023-03-12-14-50-22.png)

---

### onclick 을 통한 이벤트 연결

`onclick` 의 고전적인 문제점으로 인해서 리버스 엔지니어링이 더 쉬워집니다.

`onclick` 은 해당 오브젝트가 클릭 될 때 어떤 함수가 실행되는지 바로바로 object 창에서 확인할 수 있으므로. 권장되지 않습니다.

![](2023-03-12-14-56-48.png)

익스플로러 대응을 위해서 onclick 을 사용했다고 이야기 할 수 있지만. 익스플로러의 경우 이미 글로벌 킬 스위치가 작동했으며, 학교나 관공서 등에서 일반적으로 사용되는 윈도우 os 는 Windows10 혹은 Windows11 이므로, 익스플로러를 실행시 Edge 브라우저가 열리게 됩니다. 따라서 익스플로러의 대응은 필요하지 않으며, `addEventListener` 를 이용할 수 있습니다.

`addEventListener` 를 사용하는 경우, 다음과 같이 오브젝트 창에서 클릭시 실행되는 함수에 대한 정보를 숨길 수 있으며, 난독화시 더욱더 구조적으로 파악이 어려워지는 이점을 얻을 수 있습니다.

![](2023-03-12-15-03-12.png)

비고 : [XDA 커뮤니티 - Internet Explorer 11 will finally be killed off in February 2023](https://www.xda-developers.com/internet-explorer-windows-10-disablement/)

---

### 서버측 검증의 부재 / DOM 을 사용해 변수처리

리버스 엔지니어링으로 확인된 사이트 구조상, EBSi 의 교사확인은 서버측에서 이루워지지 않았으며, 클라이언트에서 모두 처리되었습니다.

교사 인증의 경우, tchrDown 라는 숨겨진 DOM 오브젝트에서 처리되었습니다. 즉, 콘솔상으로 유저는 다음의 오브젝트를 확인할 수 있습니다.

![](2023-03-12-15-19-51.png)

따라서, 유저는 이러한 변수들을 마음대로 조작할 수 있었습니다.
또한, 페이지 내의 함수들은 모두 외부적으로 접근할 수 있었으며, 필요에 따라 콘솔 창에서 실행할 수 있었습니다.

![](2023-03-12-15-32-03.png)

일반적으로, 교사 권한이 없는 경우 교사용 페이지를 보는 탭 버튼을 누를 수 없도록 되어 있습니다만,

페이지 내에서 파악된 코드에 의하면. [다음 페이지](https://www.ebsi.co.kr/ebs/pot/potg/beConnected2017BookDowonload.ebs) 에서 교사용 탭을 누르는 함수는 `fnTab()` 에 연결되어 있었습니다. 또한 다음 함수는 하나의 인자를 받는데, 그 인자는 검증 없이 함수에서 사용되었습니다.

![](2023-03-12-15-34-19.png)

따라서 다음과 같이 콘솔에 입력할 경우, 교사용 다운로드 페이지로 들어가지게 됩니다.

![](2023-03-12-15-34-40.png)

여기에서, 다운로드 버튼에 걸려있는 `dwCntEvent` 함수를 살펴보면

![](2023-03-12-15-35-49.png)

로그인 검증이 걸려있지만, 다운로드가 걸리는 위치를 확인해 볼 수 있었습니다.

```js
"https://lwdw.ebsi.co.kr/UpDown/LZ/bookimages/"+encodeURI(pdf);
```

`pdf` 는 `onclick` 에 걸린 `dwCntEvent` 함수 호출에 사용된 인자이므로, 버튼에서 확인해 올 수 있습니다.

다음은 수능특강 미적분 교사용 다운로드 링크를 얻어내는 코드입니다.

```js
"https://lwdw.ebsi.co.kr/UpDown/LZ/bookimages/"+encodeURI('EBS_2024학년도_수능특강_수학영역_미적분_PDF(교사용)[20230221100131080].zip')
```

> 결과 : `https://lwdw.ebsi.co.kr/UpDown/LZ/bookimages/EBS_2024%ED%95%99%EB%85%84%EB%8F%84_%EC%88%98%EB%8A%A5%ED%8A%B9%EA%B0%95_%EC%88%98%ED%95%99%EC%98%81%EC%97%AD_%EB%AF%B8%EC%A0%81%EB%B6%84_PDF(%EA%B5%90%EC%82%AC%EC%9A%A9)%5B20230221100131080%5D.zip`

이 다운로드 링크는 어떠한 쿠키 검증도 없었으며, 클릭시 로그인 상태, 교사인증 상태를 무시하고 다운로드를 할 수 있었습니다.

`lwdw.ebsi.co.kr` 는 `ebsi.co.kr` 의 하위 도메인이며, `www.ebsi.co.kr` 또한 하위 도메인이므로 `ebsi.co.kr` 에 쿠기 정보를 저장함으로써 로그인 토큰을 저장할 수 있습니다. 그러나 다운로드에 있어 어떠한 토큰 검사도 없었기 때문에 로그인 여부를 떠나 성공적으로 다운로드가 가능합니다.

![](2023-03-12-15-38-47.png)
![](2023-03-12-15-39-03.png)

내용물은 온전했으며. 오픈시 잘 열리는것을 확인할 수 있었습니다.

또한, `dwCntEvent` 함수의 구조상, `/ebs/pot/potg/beConnectedBookDowonloadCntNew.ajax` 로 카운트 요청이 실패하더라도 다운로드 되도록 `location.href` 가 변경되도록 구조가 짜여있었습니다.

`dwCntEvent` 에서 검증하는 것은 돔 오브젝트 `#LoginYN` 의 내부 텍스트 콘텐츠가 `'true'` 인지 확인하는것 뿐이였습니다. 따라서 다음과 같이 로그인을 시뮬레이션 할 수 있습니다.

![](2023-03-12-15-41-55.png)

다음 명령을 사용한 후에는, 단순히 PDF 다운로드 버튼을 누름으로써 파일을 받을 수 있었습니다.

![](2023-03-12-15-42-39.png)

이는 국어, 수학, 영어, 한국사, 사회, 과학, 직업, 제2외국어 모든 탭에서 유효했습니다.

---

### alert 의 사용

![](2023-03-12-16-10-07.png)

alert 함수는 매우 잘 알려진 함수로써, 함수 검색시 쉽게 함수가 사용된 로직의 위치를 확인할 수 있으므로 사용을 피해야 합니다.

![](2023-03-12-16-13-05.png)

## 결론

결론적으로, EBSi 페이지에는 다음과 같은 변경이 필요합니다.

1. 변수를 DOM 으로 담지 않아야함.
2. 함수가 외부에서 노출되지 않도록 (클래스에 담기 등). 유출되더라도 내용이 무엇인지 알기 힘들도록 해야함.
3. 서버측에서는 다운로드시 쿠키 인증을 걸어 잘못된 요청을 거부하도록 해야함.
4. 전반적인 난독화, minify 를 통해 코드 구조를 파악하기 어렵게 해야함.
5. 모든 코드의 주석을 사용자가 볼 수 없도록 전처리기를 통해 제거해야함
6. onclick 과 같은 외부에 직접적으로 드러나는 방식을 사용하지 말아야함. (addEventListener 을 대안으로 이용)
7. 익스플로러의 지원은 과감하게 포기해야함. 2023 년도부터 익스플로러는 공식적으로 지원이 두절되었으며 오는 6월 보안 업데이트를 통해 모든 IE 가 제거될 예정임. 따라서 절대적으로 필요하지 않으며 IE 를 위해 모든 보안성을 포기하지 말아야함.
8. JQuery 와 같은 레거시 라이브러리의 사용을 피해야함.
9. 다운로드 링크와 같은 경우, 서버측에서 임시적으로 생성하고, 리다이렉트 해더를 거는 방식으로 생성해야 하며, 클라이언트에서 생성하지 말아야함.
10. 필요에 따라, 교사 인증시 들어오는 javascript 파일과, 미인증시 들어오는 javascript 파일을 다르게 만들어야함. 즉 교사인증을 하지 않았다면 교사 인증이 필요한 부분의 로직에는 교사 인증시 돌아갈 로직을 모두 제외시켜, 리버스 엔지니어링을 원천적으로 어렵게 만들어야함.
11. `fnTab()` 함수에는 서버측 인증이 필요하며. 인증 실패시 교사용 화면이 보여지지 않도록 서버의 거부가 필요함.
12. `alert()` 함수를 대신해 화면에 직접적으로 띄워주는 창을 직접적으로 구현하고. 그 함수를 알아보기 어렵도록 만들어야함.
